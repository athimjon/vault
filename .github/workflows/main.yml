name: CI/CD Pipeline

on:
  push:
    branches:
      - main   # Runs when you push to main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout project
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Java for building your Spring Boot backend
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Build backend JAR
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # 4Ô∏è‚É£ Copy Docker and app files to server
      - name: Upload files to server via SCP
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "Dockerfile, docker-compose.yml, target/*.jar"
          target: "/tmp/izzy-deploy"

      # 5Ô∏è‚É£ Login to server and deploy with docker-compose
      - name: SSH into AWS Server and Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "üìÅ Creating project directory..."
            mkdir -p /home/${{ secrets.SSH_USER }}/izzy

            echo "üßπ Cleaning old files..."
            rm -rf /home/${{ secrets.SSH_USER }}/izzy/*

            echo "üì¶ Moving new build files..."
            mv /tmp/izzy-deploy/* /home/${{ secrets.SSH_USER }}/izzy/
            cd /home/${{ secrets.SSH_USER }}/izzy

            echo "üîê Creating .env file from GitHub Secrets..."
            cat <<EOF > .env
            DB_URL=${{ secrets.DB_URL }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            BUCKET_NAME=${{ secrets.BUCKET_NAME }}
            BUCKET_REGION=${{ secrets.BUCKET_REGION }}
            S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }}
            S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }}

            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}

            EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            EOF

            echo "üê≥ Stopping old containers..."
            docker compose down --remove-orphans || true

            echo "üßº Removing old images..."
            docker image prune -f || true

            echo "üöÄ Rebuilding and starting containers..."
            docker compose up -d --build

            echo "‚úÖ Deployment completed successfully!"
